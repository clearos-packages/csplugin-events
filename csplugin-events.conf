<?xml version="1.0" encoding="ISO-8859-1"?>
<!-- ClearSync System Monitor Plugin Configuration -->
<plugin name="System Events" library="libcsplugin-events.so" stack-size="65536">
  <state-file>/var/state/clearsync/csplugin-events.state</state-file>

  <!-- Webconfig app configuration file -->
  <extern-config>/etc/clearos/events.conf</extern-config>

  <!-- Internal alert config.d path -->
  <alert-config-path>/etc/clearos/events.d</alert-config-path>

  <!-- Auto-purge TTL
       Delete "seen" alerts older than this age (in seconds, 0 = keep forever). -->
  <auto-purge-ttl max-age="0" />

  <!-- Start-up flags:
       initdb="<true/false>", Reinitialze database on start-up? -->
  <start-up initdb="false" />

  <!-- Databases -->
  <db type="sqlite" db_filename="/var/lib/csplugin-events/events.db" />

  <!-- External control socket path -->
  <eventsctl socket="/var/lib/csplugin-events/eventsctl.socket" />

  <!-- Sources
       Source parameters for internally generated alert types. -->
  <source type="syslog" socket="/var/lib/csplugin-events/syslog.socket" />

  <!-- Alert types
       id: Unique integer (unsigned 32-bit) identifier.
     type: Alert type text tag. -->
  <types>
    <!-- Kernel events -->
    <type id="1000" type="KERN_PANIC" />

    <!-- System events -->
    <type id="2000" type="SYS_LOAD_HIGH" />
    <type id="2001" type="SYS_PROC_SEGV" />
    <type id="2002" type="SYS_FW_PANIC" />

    <!-- Memory events -->
    <type id="3000" type="MEM_RAM_LOW" />
    <type id="3001" type="MEM_SWAP_HIGH" />
    <type id="3002" type="MEM_OOM_KILLED" />

    <!-- Disk/volume events -->
    <type id="4000" type="VOLUME_FULL" />
    <type id="4001" type="VOLUME_ERROR" />

    <!-- Network events -->
    <type id="5000" type="NET_WAN_DOWN" />
    <type id="5001" type="MEM_WAN_ERROR" />

    <!-- User events -->
    <type id="6000" type="USER_LOGIN" />
    <type id="6001" type="USER_LOGOUT" />
    <type id="6002" type="USER_AUTH_FAIL" />
    <type id="6003" type="USER_INVALID" />

    <!-- Experimental events -->
    <type id="4294967295" type="TEST" />
  </types>

  <!-- Internal Alerts
       These are internally generated by the plugin. -->
  <alerts>
  <!--
    <alert type="SYS_LOAD_HIGH" level="WARN" source="inotify" path="/proc/loadavg">
      <threshold>10</threshold>
      <duration>60</duration>
      <locale lang="en">
        <text>System load warning</text>
      </locale>
    </alert>

    <alert type="NET_WAN_DOWN" level="WARN" source="inotify" path="/var/lib/syswatch/state">
      <locale lang="en">
        <text>External network interface down ($iface)</text>
      </locale>
    </alert>
    -->

    <alert type="USER_LOGIN" level="NORM" source="syslog">
      <locale lang="en">
        <text>User $user logged in via $service</text>
        <match index="1" name="service" />
        <match index="2" name="user" />
        <pattern>pam_unix\(([A-z_\.-]*):session\): session opened for user (.*) by.*$</pattern>
      </locale>
    </alert>

    <alert type="USER_LOGOUT" level="NORM" source="syslog">
      <locale lang="en">
        <text>User $user logged out via $service</text>
        <match index="1" name="service" />
        <match index="2" name="user" />
        <pattern>pam_unix\(([A-z_\.-]*):session\): session closed for user (.*$)</pattern>
      </locale>
    </alert>

    <alert type="USER_INVALID" level="WARN" source="syslog">
      <locale lang="en">
        <text>Failed login attempt by invalid user $user from $host</text>
        <match index="1" name="user" />
        <match index="2" name="host" />
        <pattern>Invalid user ([A-z_\.-]*) from (.*$)</pattern>
      </locale>
    </alert>

    <alert type="USER_AUTH_FAIL" level="WARN" source="syslog">
      <locale lang="en">
        <text>Authentication failure for $user_src switching to $user_dst</text>
        <match index="1" name="user_src" />
        <match index="2" name="user_dst" />
        <pattern>pam_unix\(su[A-z_\.-]*:auth\): authentication failure;.*ruser=([A-z_\.-]*) .*user=([A-z_\.-]*)</pattern>
      </locale>
    </alert>

    <alert type="USER_AUTH_FAIL" level="WARN" source="syslog">
      <locale lang="en">
        <text>Authentication failure for $user via $service from $host</text>
        <match index="1" name="service" />
        <match index="2" name="host" />
        <match index="3" name="user" />
        <pattern>pam_unix\(([A-z_\.-]*):auth\): authentication failure;.*rhost=([A-z0-9\.:.-]*) .*user=(.*$)</pattern>
      </locale>
    </alert>

    <alert type="USER_AUTH_FAIL" level="WARN" source="syslog">
      <locale lang="en">
        <text>Authentication failure for $user via $service</text>
        <match index="1" name="service" />
        <match index="2" name="user" />
        <pattern>pam_unix\(([A-z_\.-]*):auth\): authentication failure;.*user=([A-z_\.-]*)</pattern>
      </locale>
    </alert>

    <alert type="MEM_OOM_KILLED" level="CRIT" source="syslog">
      <locale lang="en">
        <text>Low memory; process $process ($pid) killed</text>
        <match index="1" name="pid" />
        <match index="2" name="process" />
        <pattern>Out of memory: Kill process ([0-9]*) \((.*)\)</pattern>
      </locale>
    </alert>

    <alert type="SYS_PROC_SEGV" level="CRIT" source="syslog">
      <locale lang="en">
        <text>Process $process ($pid) exited abormally</text>
        <match index="1" name="process" />
        <match index="2" name="pid" />
        <!-- clearsyncd[754]: segfault at 0 ip (null) sp 00007fff3be5ea78 error 4 in clearsyncd[400000+c000] -->
        <pattern>&lt;[0-9]{2}&gt;(.*)\[([0-9]*)\]: segfault</pattern>
      </locale>
    </alert>
  </alerts>
</plugin>
<!--
  vi: syntax=xml expandtab shiftwidth=2 softtabstop=2 tabstop=2
-->
